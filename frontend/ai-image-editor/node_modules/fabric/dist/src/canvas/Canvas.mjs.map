{"version":3,"file":"Canvas.mjs","sources":["../../../src/canvas/Canvas.ts"],"sourcesContent":["import { classRegistry } from '../ClassRegistry';\nimport { NONE } from '../constants';\nimport type {\n  CanvasEvents,\n  DragEventData,\n  ObjectEvents,\n  TEventsExtraData,\n  TPointerEvent,\n  TPointerEventNames,\n  Transform,\n} from '../EventTypeDefs';\nimport { Point } from '../Point';\nimport type { ActiveSelection } from '../shapes/ActiveSelection';\nimport type { Group } from '../shapes/Group';\nimport type { IText } from '../shapes/IText/IText';\nimport type { FabricObject } from '../shapes/Object/FabricObject';\nimport { isTouchEvent, stopEvent } from '../util/dom_event';\nimport { getDocumentFromElement, getWindowFromElement } from '../util/dom_misc';\nimport { sendPointToPlane } from '../util/misc/planeChange';\nimport { isActiveSelection } from '../util/typeAssertions';\nimport type { CanvasOptions, TCanvasOptions } from './CanvasOptions';\nimport { SelectableCanvas } from './SelectableCanvas';\nimport { TextEditingManager } from './TextEditingManager';\n\nconst addEventOptions = { passive: false } as EventListenerOptions;\n\nconst getEventPoints = (canvas: Canvas, e: TPointerEvent) => {\n  const viewportPoint = canvas.getViewportPoint(e);\n  const scenePoint = canvas.getScenePoint(e);\n  return {\n    viewportPoint,\n    scenePoint,\n    pointer: viewportPoint,\n    absolutePointer: scenePoint,\n  };\n};\n\n// just to be clear, the utils are now deprecated and those are here exactly as minifier helpers\n// because el.addEventListener can't me be minified while a const yes and we use it 47 times in this file.\n// few bytes but why give it away.\nconst addListener = (\n  el: HTMLElement | Document,\n  ...args: Parameters<HTMLElement['addEventListener']>\n) => el.addEventListener(...args);\nconst removeListener = (\n  el: HTMLElement | Document,\n  ...args: Parameters<HTMLElement['removeEventListener']>\n) => el.removeEventListener(...args);\n\nconst syntheticEventConfig = {\n  mouse: {\n    in: 'over',\n    out: 'out',\n    targetIn: 'mouseover',\n    targetOut: 'mouseout',\n    canvasIn: 'mouse:over',\n    canvasOut: 'mouse:out',\n  },\n  drag: {\n    in: 'enter',\n    out: 'leave',\n    targetIn: 'dragenter',\n    targetOut: 'dragleave',\n    canvasIn: 'drag:enter',\n    canvasOut: 'drag:leave',\n  },\n} as const;\n\ntype TSyntheticEventContext = {\n  mouse: { e: TPointerEvent };\n  drag: DragEventData;\n};\n\nexport class Canvas extends SelectableCanvas implements CanvasOptions {\n  /**\n   * Contains the id of the touch event that owns the fabric transform\n   * @type Number\n   * @private\n   */\n  declare mainTouchId?: number;\n\n  declare enablePointerEvents: boolean;\n\n  /**\n   * Holds a reference to a setTimeout timer for event synchronization\n   * @type number\n   * @private\n   */\n  private declare _willAddMouseDown: number;\n\n  /**\n   * Holds a reference to an object on the canvas that is receiving the drag over event.\n   * @type FabricObject\n   * @private\n   */\n  private declare _draggedoverTarget?: FabricObject;\n\n  /**\n   * Holds a reference to an object on the canvas from where the drag operation started\n   * @type FabricObject\n   * @private\n   */\n  private declare _dragSource?: FabricObject;\n\n  /**\n   * Holds a reference to an object on the canvas that is the current drop target\n   * May differ from {@link _draggedoverTarget}\n   * @todo inspect whether {@link _draggedoverTarget} and {@link _dropTarget} should be merged somehow\n   * @type FabricObject\n   * @private\n   */\n  private declare _dropTarget: FabricObject<ObjectEvents> | undefined;\n\n  /**\n   * a boolean that keeps track of the click state during a cycle of mouse down/up.\n   * If a mouse move occurs it becomes false.\n   * Is true by default, turns false on mouse move.\n   * Used to determine if a mouseUp is a click\n   */\n  private _isClick: boolean;\n\n  textEditingManager = new TextEditingManager(this);\n\n  constructor(el?: string | HTMLCanvasElement, options: TCanvasOptions = {}) {\n    super(el, options);\n    // bind event handlers\n    (\n      [\n        '_onMouseDown',\n        '_onTouchStart',\n        '_onMouseMove',\n        '_onMouseUp',\n        '_onTouchEnd',\n        '_onResize',\n        // '_onGesture',\n        // '_onDrag',\n        // '_onShake',\n        // '_onLongPress',\n        // '_onOrientationChange',\n        '_onMouseWheel',\n        '_onMouseOut',\n        '_onMouseEnter',\n        '_onContextMenu',\n        '_onClick',\n        '_onDragStart',\n        '_onDragEnd',\n        '_onDragProgress',\n        '_onDragOver',\n        '_onDragEnter',\n        '_onDragLeave',\n        '_onDrop',\n      ] as (keyof this)[]\n    ).forEach((eventHandler) => {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n      this[eventHandler] = (this[eventHandler] as Function).bind(this);\n    });\n    // register event handlers\n    this.addOrRemove(addListener, 'add');\n  }\n\n  /**\n   * return an event prefix pointer or mouse.\n   * @private\n   */\n  private _getEventPrefix() {\n    return this.enablePointerEvents ? 'pointer' : 'mouse';\n  }\n\n  addOrRemove(functor: any, _eventjsFunctor: 'add' | 'remove') {\n    const canvasElement = this.upperCanvasEl,\n      eventTypePrefix = this._getEventPrefix();\n    functor(getWindowFromElement(canvasElement), 'resize', this._onResize);\n    functor(canvasElement, eventTypePrefix + 'down', this._onMouseDown);\n    functor(\n      canvasElement,\n      `${eventTypePrefix}move`,\n      this._onMouseMove,\n      addEventOptions,\n    );\n    functor(canvasElement, `${eventTypePrefix}out`, this._onMouseOut);\n    functor(canvasElement, `${eventTypePrefix}enter`, this._onMouseEnter);\n    functor(canvasElement, 'wheel', this._onMouseWheel);\n    functor(canvasElement, 'contextmenu', this._onContextMenu);\n    functor(canvasElement, 'click', this._onClick);\n    // decide if to remove in fabric 7.0\n    functor(canvasElement, 'dblclick', this._onClick);\n    functor(canvasElement, 'dragstart', this._onDragStart);\n    functor(canvasElement, 'dragend', this._onDragEnd);\n    functor(canvasElement, 'dragover', this._onDragOver);\n    functor(canvasElement, 'dragenter', this._onDragEnter);\n    functor(canvasElement, 'dragleave', this._onDragLeave);\n    functor(canvasElement, 'drop', this._onDrop);\n    if (!this.enablePointerEvents) {\n      functor(canvasElement, 'touchstart', this._onTouchStart, addEventOptions);\n    }\n    // if (typeof eventjs !== 'undefined' && eventjsFunctor in eventjs) {\n    //   eventjs[eventjsFunctor](canvasElement, 'gesture', this._onGesture);\n    //   eventjs[eventjsFunctor](canvasElement, 'drag', this._onDrag);\n    //   eventjs[eventjsFunctor](\n    //     canvasElement,\n    //     'orientation',\n    //     this._onOrientationChange\n    //   );\n    //   eventjs[eventjsFunctor](canvasElement, 'shake', this._onShake);\n    //   eventjs[eventjsFunctor](canvasElement, 'longpress', this._onLongPress);\n    // }\n  }\n\n  /**\n   * Removes all event listeners, used when disposing the instance\n   */\n  removeListeners() {\n    this.addOrRemove(removeListener, 'remove');\n    // if you dispose on a mouseDown, before mouse up, you need to clean document to...\n    const eventTypePrefix = this._getEventPrefix();\n    const doc = getDocumentFromElement(this.upperCanvasEl);\n    removeListener(\n      doc,\n      `${eventTypePrefix}up`,\n      this._onMouseUp as EventListener,\n    );\n    removeListener(\n      doc,\n      'touchend',\n      this._onTouchEnd as EventListener,\n      addEventOptions,\n    );\n    removeListener(\n      doc,\n      `${eventTypePrefix}move`,\n      this._onMouseMove as EventListener,\n      addEventOptions,\n    );\n    removeListener(\n      doc,\n      'touchmove',\n      this._onMouseMove as EventListener,\n      addEventOptions,\n    );\n    clearTimeout(this._willAddMouseDown);\n  }\n\n  /**\n   * @private\n   * @param {Event} [e] Event object fired on wheel event\n   */\n  private _onMouseWheel(e: MouseEvent) {\n    this.__onMouseWheel(e);\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  private _onMouseOut(e: TPointerEvent) {\n    const target = this._hoveredTarget;\n    const shared = {\n      e,\n      ...getEventPoints(this, e),\n    };\n    this.fire('mouse:out', { ...shared, target });\n    this._hoveredTarget = undefined;\n    target && target.fire('mouseout', { ...shared });\n    this._hoveredTargets.forEach((nestedTarget) => {\n      this.fire('mouse:out', { ...shared, target: nestedTarget });\n      nestedTarget && nestedTarget.fire('mouseout', { ...shared });\n    });\n    this._hoveredTargets = [];\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mouseenter\n   */\n  private _onMouseEnter(e: TPointerEvent) {\n    // This find target and consequent 'mouse:over' is used to\n    // clear old instances on hovered target.\n    // calling findTarget has the side effect of killing target.__corner.\n    // as a short term fix we are not firing this if we are currently transforming.\n    // as a long term fix we need to separate the action of finding a target with the\n    // side effects we added to it.\n    if (!this._currentTransform && !this.findTarget(e)) {\n      this.fire('mouse:over', {\n        e,\n        ...getEventPoints(this, e),\n      });\n      this._hoveredTarget = undefined;\n      this._hoveredTargets = [];\n    }\n  }\n\n  /**\n   * supports native like text dragging\n   * @private\n   * @param {DragEvent} e\n   */\n  private _onDragStart(e: DragEvent) {\n    this._isClick = false;\n    const activeObject = this.getActiveObject();\n    if (activeObject && activeObject.onDragStart(e)) {\n      this._dragSource = activeObject;\n      const options = { e, target: activeObject };\n      this.fire('dragstart', options);\n      activeObject.fire('dragstart', options);\n      addListener(\n        this.upperCanvasEl,\n        'drag',\n        this._onDragProgress as EventListener,\n      );\n      return;\n    }\n    stopEvent(e);\n  }\n\n  /**\n   * First we clear top context where the effects are being rendered.\n   * Then we render the effects.\n   * Doing so will render the correct effect for all cases including an overlap between `source` and `target`.\n   * @private\n   */\n  private _renderDragEffects(\n    e: DragEvent,\n    source?: FabricObject,\n    target?: FabricObject,\n  ) {\n    let dirty = false;\n    // clear top context\n    const dropTarget = this._dropTarget;\n    if (dropTarget && dropTarget !== source && dropTarget !== target) {\n      dropTarget.clearContextTop();\n      dirty = true;\n    }\n    source?.clearContextTop();\n    target !== source && target?.clearContextTop();\n    // render effects\n    const ctx = this.contextTop;\n    ctx.save();\n    ctx.transform(...this.viewportTransform);\n    if (source) {\n      ctx.save();\n      source.transform(ctx);\n      source.renderDragSourceEffect(e);\n      ctx.restore();\n      dirty = true;\n    }\n    if (target) {\n      ctx.save();\n      target.transform(ctx);\n      target.renderDropTargetEffect(e);\n      ctx.restore();\n      dirty = true;\n    }\n    ctx.restore();\n    dirty && (this.contextTopDirty = true);\n  }\n\n  /**\n   * supports native like text dragging\n   * https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/Drag_operations#finishing_a_drag\n   * @private\n   * @param {DragEvent} e\n   */\n  private _onDragEnd(e: DragEvent) {\n    const didDrop = !!e.dataTransfer && e.dataTransfer.dropEffect !== NONE,\n      dropTarget = didDrop ? this._activeObject : undefined,\n      options = {\n        e,\n        target: this._dragSource as FabricObject,\n        subTargets: this.targets,\n        dragSource: this._dragSource as FabricObject,\n        didDrop,\n        dropTarget: dropTarget as FabricObject,\n      };\n    removeListener(\n      this.upperCanvasEl,\n      'drag',\n      this._onDragProgress as EventListener,\n    );\n    this.fire('dragend', options);\n    this._dragSource && this._dragSource.fire('dragend', options);\n    delete this._dragSource;\n    // we need to call mouse up synthetically because the browser won't\n    this._onMouseUp(e);\n  }\n\n  /**\n   * fire `drag` event on canvas and drag source\n   * @private\n   * @param {DragEvent} e\n   */\n  private _onDragProgress(e: DragEvent) {\n    const options = {\n      e,\n      target: this._dragSource as FabricObject | undefined,\n      dragSource: this._dragSource as FabricObject | undefined,\n      dropTarget: this._draggedoverTarget as FabricObject,\n    };\n    this.fire('drag', options);\n    this._dragSource && this._dragSource.fire('drag', options);\n  }\n\n  /**\n   * As opposed to {@link findTarget} we want the top most object to be returned w/o the active object cutting in line.\n   * Override at will\n   */\n  protected findDragTargets(e: DragEvent) {\n    this.targets = [];\n    const target = this._searchPossibleTargets(\n      this._objects,\n      this.getViewportPoint(e),\n    );\n    return {\n      target,\n      targets: [...this.targets],\n    };\n  }\n\n  /**\n   * prevent default to allow drop event to be fired\n   * https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/Drag_operations#specifying_drop_targets\n   * @private\n   * @param {DragEvent} [e] Event object fired on Event.js shake\n   */\n  private _onDragOver(e: DragEvent) {\n    const eventType = 'dragover';\n    const { target, targets } = this.findDragTargets(e);\n    const dragSource = this._dragSource as FabricObject;\n    const options = {\n      e,\n      target,\n      subTargets: targets,\n      dragSource,\n      canDrop: false,\n      dropTarget: undefined,\n    };\n    let dropTarget;\n    //  fire on canvas\n    this.fire(eventType, options);\n    //  make sure we fire dragenter events before dragover\n    //  if dragleave is needed, object will not fire dragover so we don't need to trouble ourselves with it\n    this._fireEnterLeaveEvents(target, options);\n    if (target) {\n      if (target.canDrop(e)) {\n        dropTarget = target;\n      }\n      target.fire(eventType, options);\n    }\n    //  propagate the event to subtargets\n    for (let i = 0; i < targets.length; i++) {\n      const subTarget = targets[i];\n      // accept event only if previous targets didn't (the accepting target calls `preventDefault` to inform that the event is taken)\n      // TODO: verify if those should loop in inverse order then?\n      // what is the order of subtargets?\n      if (subTarget.canDrop(e)) {\n        dropTarget = subTarget;\n      }\n      subTarget.fire(eventType, options);\n    }\n    //  render drag effects now that relations between source and target is clear\n    this._renderDragEffects(e, dragSource, dropTarget);\n    this._dropTarget = dropTarget;\n  }\n\n  /**\n   * fire `dragleave` on `dragover` targets\n   * @private\n   * @param {Event} [e] Event object fired on Event.js shake\n   */\n  private _onDragEnter(e: DragEvent) {\n    const { target, targets } = this.findDragTargets(e);\n    const options = {\n      e,\n      target,\n      subTargets: targets,\n      dragSource: this._dragSource,\n    };\n    this.fire('dragenter', options);\n    //  fire dragenter on targets\n    this._fireEnterLeaveEvents(target, options);\n  }\n\n  /**\n   * fire `dragleave` on `dragover` targets\n   * @private\n   * @param {Event} [e] Event object fired on Event.js shake\n   */\n  private _onDragLeave(e: DragEvent) {\n    const options = {\n      e,\n      target: this._draggedoverTarget,\n      subTargets: this.targets,\n      dragSource: this._dragSource,\n    };\n    this.fire('dragleave', options);\n\n    //  fire dragleave on targets\n    this._fireEnterLeaveEvents(undefined, options);\n    this._renderDragEffects(e, this._dragSource);\n    this._dropTarget = undefined;\n    //  clear targets\n    this.targets = [];\n    this._hoveredTargets = [];\n  }\n\n  /**\n   * `drop:before` is a an event that allows you to schedule logic\n   * before the `drop` event. Prefer `drop` event always, but if you need\n   * to run some drop-disabling logic on an event, since there is no way\n   * to handle event handlers ordering, use `drop:before`\n   * @private\n   * @param {Event} e\n   */\n  private _onDrop(e: DragEvent) {\n    const { target, targets } = this.findDragTargets(e);\n    const options = this._basicEventHandler('drop:before', {\n      e,\n      target,\n      subTargets: targets,\n      dragSource: this._dragSource,\n      ...getEventPoints(this, e),\n    });\n    //  will be set by the drop target\n    options.didDrop = false;\n    //  will be set by the drop target, used in case options.target refuses the drop\n    options.dropTarget = undefined;\n    //  fire `drop`\n    this._basicEventHandler('drop', options);\n    //  inform canvas of the drop\n    //  we do this because canvas was unaware of what happened at the time the `drop` event was fired on it\n    //  use for side effects\n    this.fire('drop:after', options);\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  private _onContextMenu(e: TPointerEvent): false {\n    const target = this.findTarget(e),\n      subTargets = this.targets || [];\n    const options = this._basicEventHandler('contextmenu:before', {\n      e,\n      target,\n      subTargets,\n    });\n    // TODO: this line is silly because the dev can subscribe to the event and prevent it themselves\n    this.stopContextMenu && stopEvent(e);\n    this._basicEventHandler('contextmenu', options);\n    return false;\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  private _onClick(e: TPointerEvent) {\n    const clicks = e.detail;\n    if (clicks > 3 || clicks < 2) return;\n    this._cacheTransformEventData(e);\n    clicks == 2 && e.type === 'dblclick' && this._handleEvent(e, 'dblclick');\n    clicks == 3 && this._handleEvent(e, 'tripleclick');\n    this._resetTransformEventData();\n  }\n\n  /**\n   * Return a the id of an event.\n   * returns either the pointerId or the identifier or 0 for the mouse event\n   * @private\n   * @param {Event} evt Event object\n   */\n  getPointerId(evt: TouchEvent | PointerEvent): number {\n    const changedTouches = (evt as TouchEvent).changedTouches;\n\n    if (changedTouches) {\n      return changedTouches[0] && changedTouches[0].identifier;\n    }\n\n    if (this.enablePointerEvents) {\n      return (evt as PointerEvent).pointerId;\n    }\n\n    return -1;\n  }\n\n  /**\n   * Determines if an event has the id of the event that is considered main\n   * @private\n   * @param {evt} event Event object\n   */\n  _isMainEvent(evt: TPointerEvent): boolean {\n    if ((evt as PointerEvent).isPrimary === true) {\n      return true;\n    }\n    if ((evt as PointerEvent).isPrimary === false) {\n      return false;\n    }\n    if (evt.type === 'touchend' && (evt as TouchEvent).touches.length === 0) {\n      return true;\n    }\n    if ((evt as TouchEvent).changedTouches) {\n      return (\n        (evt as TouchEvent).changedTouches[0].identifier === this.mainTouchId\n      );\n    }\n    return true;\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  _onTouchStart(e: TouchEvent) {\n    // we will prevent scrolling if allowTouchScrolling is not enabled and\n    let shouldPreventScrolling = !this.allowTouchScrolling;\n    const currentActiveObject = this._activeObject;\n    if (this.mainTouchId === undefined) {\n      this.mainTouchId = this.getPointerId(e);\n    }\n    this.__onMouseDown(e);\n    // after executing fabric logic for mouse down let's see\n    // if we didn't change target or if we are drawing\n    // we want to prevent scrolling anyway\n    if (\n      this.isDrawingMode ||\n      (currentActiveObject && this._target === currentActiveObject)\n    ) {\n      shouldPreventScrolling = true;\n    }\n    // prevent default, will block scrolling from start\n    shouldPreventScrolling && e.preventDefault();\n    this._resetTransformEventData();\n    const canvasElement = this.upperCanvasEl,\n      eventTypePrefix = this._getEventPrefix();\n    const doc = getDocumentFromElement(canvasElement);\n    addListener(\n      doc,\n      'touchend',\n      this._onTouchEnd as EventListener,\n      addEventOptions,\n    );\n    // if we scroll don't register the touch move event\n    shouldPreventScrolling &&\n      addListener(\n        doc,\n        'touchmove',\n        this._onMouseMove as EventListener,\n        addEventOptions,\n      );\n    // Unbind mousedown to prevent double triggers from touch devices\n    removeListener(\n      canvasElement,\n      `${eventTypePrefix}down`,\n      this._onMouseDown as EventListener,\n    );\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  _onMouseDown(e: TPointerEvent) {\n    this.__onMouseDown(e);\n    this._resetTransformEventData();\n    const canvasElement = this.upperCanvasEl,\n      eventTypePrefix = this._getEventPrefix();\n    removeListener(\n      canvasElement,\n      `${eventTypePrefix}move`,\n      this._onMouseMove as EventListener,\n      addEventOptions,\n    );\n    const doc = getDocumentFromElement(canvasElement);\n    addListener(doc, `${eventTypePrefix}up`, this._onMouseUp as EventListener);\n    addListener(\n      doc,\n      `${eventTypePrefix}move`,\n      this._onMouseMove as EventListener,\n      addEventOptions,\n    );\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  _onTouchEnd(e: TouchEvent) {\n    if (e.touches.length > 0) {\n      // if there are still touches stop here\n      return;\n    }\n    this.__onMouseUp(e);\n    this._resetTransformEventData();\n    delete this.mainTouchId;\n    const eventTypePrefix = this._getEventPrefix();\n    const doc = getDocumentFromElement(this.upperCanvasEl);\n    removeListener(\n      doc,\n      'touchend',\n      this._onTouchEnd as EventListener,\n      addEventOptions,\n    );\n    removeListener(\n      doc,\n      'touchmove',\n      this._onMouseMove as EventListener,\n      addEventOptions,\n    );\n    if (this._willAddMouseDown) {\n      clearTimeout(this._willAddMouseDown);\n    }\n    this._willAddMouseDown = setTimeout(() => {\n      // Wait 400ms before rebinding mousedown to prevent double triggers\n      // from touch devices\n      addListener(\n        this.upperCanvasEl,\n        `${eventTypePrefix}down`,\n        this._onMouseDown as EventListener,\n      );\n      this._willAddMouseDown = 0;\n    }, 400) as unknown as number;\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mouseup\n   */\n  _onMouseUp(e: TPointerEvent) {\n    this.__onMouseUp(e);\n    this._resetTransformEventData();\n    const canvasElement = this.upperCanvasEl,\n      eventTypePrefix = this._getEventPrefix();\n    if (this._isMainEvent(e)) {\n      const doc = getDocumentFromElement(this.upperCanvasEl);\n      removeListener(\n        doc,\n        `${eventTypePrefix}up`,\n        this._onMouseUp as EventListener,\n      );\n      removeListener(\n        doc,\n        `${eventTypePrefix}move`,\n        this._onMouseMove as EventListener,\n        addEventOptions,\n      );\n      addListener(\n        canvasElement,\n        `${eventTypePrefix}move`,\n        this._onMouseMove as EventListener,\n        addEventOptions,\n      );\n    }\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousemove\n   */\n  _onMouseMove(e: TPointerEvent) {\n    const activeObject = this.getActiveObject();\n    !this.allowTouchScrolling &&\n      (!activeObject ||\n        // a drag event sequence is started by the active object flagging itself on mousedown / mousedown:before\n        // we must not prevent the event's default behavior in order for the window to start dragging\n        !activeObject.shouldStartDragging(e)) &&\n      e.preventDefault &&\n      e.preventDefault();\n    this.__onMouseMove(e);\n  }\n\n  /**\n   * @private\n   */\n  _onResize() {\n    this.calcOffset();\n    this._resetTransformEventData();\n  }\n\n  /**\n   * Decides whether the canvas should be redrawn in mouseup and mousedown events.\n   * @private\n   * @param {Object} target\n   */\n  _shouldRender(target: FabricObject | undefined) {\n    const activeObject = this.getActiveObject();\n    // if just one of them is available or if they are both but are different objects\n    // this covers: switch of target, from target to no target, selection of target\n    // multiSelection with key and mouse\n    return (\n      !!activeObject !== !!target ||\n      (activeObject && target && activeObject !== target)\n    );\n  }\n\n  /**\n   * Method that defines the actions when mouse is released on canvas.\n   * The method resets the currentTransform parameters, store the image corner\n   * position in the image object and render the canvas on top.\n   * @private\n   * @param {Event} e Event object fired on mouseup\n   */\n  __onMouseUp(e: TPointerEvent) {\n    this._cacheTransformEventData(e);\n    this._handleEvent(e, 'up:before');\n\n    const transform = this._currentTransform;\n    const isClick = this._isClick;\n    const target = this._target;\n\n    // if right/middle click just fire events and return\n    // target undefined will make the _handleEvent search the target\n    const { button } = e as MouseEvent;\n    if (button) {\n      ((this.fireMiddleClick && button === 1) ||\n        (this.fireRightClick && button === 2)) &&\n        this._handleEvent(e, 'up');\n      this._resetTransformEventData();\n      return;\n    }\n\n    if (this.isDrawingMode && this._isCurrentlyDrawing) {\n      this._onMouseUpInDrawingMode(e);\n      return;\n    }\n\n    if (!this._isMainEvent(e)) {\n      return;\n    }\n    let shouldRender = false;\n    if (transform) {\n      this._finalizeCurrentTransform(e);\n      shouldRender = transform.actionPerformed;\n    }\n    if (!isClick) {\n      const targetWasActive = target === this._activeObject;\n      this.handleSelection(e);\n      if (!shouldRender) {\n        shouldRender =\n          this._shouldRender(target) ||\n          (!targetWasActive && target === this._activeObject);\n      }\n    }\n    let pointer, corner;\n    if (target) {\n      const found = target.findControl(\n        this.getViewportPoint(e),\n        isTouchEvent(e),\n      );\n      const { key, control } = found || {};\n      corner = key;\n      if (\n        target.selectable &&\n        target !== this._activeObject &&\n        target.activeOn === 'up'\n      ) {\n        this.setActiveObject(target, e);\n        shouldRender = true;\n      } else if (control) {\n        const mouseUpHandler = control.getMouseUpHandler(e, target, control);\n        if (mouseUpHandler) {\n          pointer = this.getScenePoint(e);\n          mouseUpHandler.call(control, e, transform!, pointer.x, pointer.y);\n        }\n      }\n      target.isMoving = false;\n    }\n    // if we are ending up a transform on a different control or a new object\n    // fire the original mouse up from the corner that started the transform\n    if (\n      transform &&\n      (transform.target !== target || transform.corner !== corner)\n    ) {\n      const originalControl =\n          transform.target && transform.target.controls[transform.corner],\n        originalMouseUpHandler =\n          originalControl &&\n          originalControl.getMouseUpHandler(\n            e,\n            transform.target,\n            originalControl,\n          );\n      pointer = pointer || this.getScenePoint(e);\n      originalMouseUpHandler &&\n        originalMouseUpHandler.call(\n          originalControl,\n          e,\n          transform,\n          pointer.x,\n          pointer.y,\n        );\n    }\n    this._setCursorFromEvent(e, target);\n    this._handleEvent(e, 'up');\n    this._groupSelector = null;\n    this._currentTransform = null;\n    // reset the target information about which corner is selected\n    target && (target.__corner = undefined);\n    if (shouldRender) {\n      this.requestRenderAll();\n    } else if (!isClick && !(this._activeObject as IText)?.isEditing) {\n      this.renderTop();\n    }\n  }\n\n  _basicEventHandler<T extends keyof (CanvasEvents | ObjectEvents)>(\n    eventType: T,\n    options: (CanvasEvents & ObjectEvents)[T],\n  ) {\n    const { target, subTargets = [] } = options as {\n      target?: FabricObject;\n      subTargets: FabricObject[];\n    };\n    this.fire(eventType, options);\n    target && target.fire(eventType, options);\n    for (let i = 0; i < subTargets.length; i++) {\n      subTargets[i] !== target && subTargets[i].fire(eventType, options);\n    }\n    return options;\n  }\n\n  /**\n   * @private\n   * Handle event firing for target and subtargets\n   * @param {TPointerEvent} e event from mouse\n   * @param {TPointerEventNames} eventType\n   */\n  _handleEvent<T extends TPointerEventNames>(\n    e: TPointerEvent,\n    eventType: T,\n    extraData?: TEventsExtraData[T],\n  ) {\n    const target = this._target,\n      targets = this.targets || [],\n      options: CanvasEvents[`mouse:${T}`] = {\n        e,\n        target,\n        subTargets: targets,\n        ...getEventPoints(this, e),\n        transform: this._currentTransform,\n        ...(eventType === 'up:before' || eventType === 'up'\n          ? {\n              isClick: this._isClick,\n              currentTarget: this.findTarget(e),\n              // set by the preceding `findTarget` call\n              currentSubTargets: this.targets,\n            }\n          : {}),\n        ...(eventType === 'down:before' || eventType === 'down'\n          ? extraData\n          : {}),\n      } as CanvasEvents[`mouse:${T}`];\n    this.fire(`mouse:${eventType}`, options);\n    // this may be a little be more complicated of what we want to handle\n    target && target.fire(`mouse${eventType}`, options);\n    for (let i = 0; i < targets.length; i++) {\n      targets[i] !== target && targets[i].fire(`mouse${eventType}`, options);\n    }\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  _onMouseDownInDrawingMode(e: TPointerEvent) {\n    this._isCurrentlyDrawing = true;\n    if (this.getActiveObject()) {\n      this.discardActiveObject(e);\n      this.requestRenderAll();\n    }\n    // TODO: this is a scene point so it should be renamed\n    const pointer = this.getScenePoint(e);\n    this.freeDrawingBrush &&\n      this.freeDrawingBrush.onMouseDown(pointer, { e, pointer });\n    this._handleEvent(e, 'down', { alreadySelected: false });\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mousemove\n   */\n  _onMouseMoveInDrawingMode(e: TPointerEvent) {\n    if (this._isCurrentlyDrawing) {\n      const pointer = this.getScenePoint(e);\n      this.freeDrawingBrush &&\n        this.freeDrawingBrush.onMouseMove(pointer, {\n          e,\n          // this is an absolute pointer, the naming is wrong\n          pointer,\n        });\n    }\n    this.setCursor(this.freeDrawingCursor);\n    this._handleEvent(e, 'move');\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event object fired on mouseup\n   */\n  _onMouseUpInDrawingMode(e: TPointerEvent) {\n    const pointer = this.getScenePoint(e);\n    if (this.freeDrawingBrush) {\n      this._isCurrentlyDrawing = !!this.freeDrawingBrush.onMouseUp({\n        e: e,\n        // this is an absolute pointer, the naming is wrong\n        pointer,\n      });\n    } else {\n      this._isCurrentlyDrawing = false;\n    }\n    this._handleEvent(e, 'up');\n  }\n\n  /**\n   * Method that defines the actions when mouse is clicked on canvas.\n   * The method inits the currentTransform parameters and renders all the\n   * canvas so the current image can be placed on the top canvas and the rest\n   * in on the container one.\n   * @private\n   * @param {Event} e Event object fired on mousedown\n   */\n  __onMouseDown(e: TPointerEvent) {\n    this._isClick = true;\n    this._cacheTransformEventData(e);\n    this._handleEvent(e, 'down:before');\n\n    let target: FabricObject | undefined = this._target;\n    let alreadySelected = !!target && target === this._activeObject;\n    // if right/middle click just fire events\n    const { button } = e as MouseEvent;\n    if (button) {\n      ((this.fireMiddleClick && button === 1) ||\n        (this.fireRightClick && button === 2)) &&\n        this._handleEvent(e, 'down', {\n          alreadySelected,\n        });\n      this._resetTransformEventData();\n      return;\n    }\n\n    if (this.isDrawingMode) {\n      this._onMouseDownInDrawingMode(e);\n      return;\n    }\n\n    if (!this._isMainEvent(e)) {\n      return;\n    }\n\n    // ignore if some object is being transformed at this moment\n    if (this._currentTransform) {\n      return;\n    }\n\n    let shouldRender = this._shouldRender(target);\n    let grouped = false;\n    if (this.handleMultiSelection(e, target)) {\n      // active object might have changed while grouping\n      target = this._activeObject;\n      grouped = true;\n      shouldRender = true;\n    } else if (this._shouldClearSelection(e, target)) {\n      this.discardActiveObject(e);\n    }\n    // we start a group selector rectangle if\n    // selection is enabled\n    // and there is no target, or the following 3 conditions are satisfied:\n    // target is not selectable ( otherwise we selected it )\n    // target is not editing\n    // target is not already selected ( otherwise we drag )\n    if (\n      this.selection &&\n      (!target ||\n        (!target.selectable &&\n          !(target as IText).isEditing &&\n          target !== this._activeObject))\n    ) {\n      const p = this.getScenePoint(e);\n      this._groupSelector = {\n        x: p.x,\n        y: p.y,\n        deltaY: 0,\n        deltaX: 0,\n      };\n    }\n\n    // check again because things could have changed\n    alreadySelected = !!target && target === this._activeObject;\n    if (target) {\n      if (target.selectable && target.activeOn === 'down') {\n        this.setActiveObject(target, e);\n      }\n      const handle = target.findControl(\n        this.getViewportPoint(e),\n        isTouchEvent(e),\n      );\n      if (target === this._activeObject && (handle || !grouped)) {\n        this._setupCurrentTransform(e, target, alreadySelected);\n        const control = handle ? handle.control : undefined,\n          pointer = this.getScenePoint(e),\n          mouseDownHandler =\n            control && control.getMouseDownHandler(e, target, control);\n        mouseDownHandler &&\n          mouseDownHandler.call(\n            control,\n            e,\n            this._currentTransform!,\n            pointer.x,\n            pointer.y,\n          );\n      }\n    }\n    //  we clear `_objectsToRender` in case of a change in order to repopulate it at rendering\n    //  run before firing the `down` event to give the dev a chance to populate it themselves\n    shouldRender && (this._objectsToRender = undefined);\n    this._handleEvent(e, 'down', { alreadySelected: alreadySelected });\n    // we must renderAll so that we update the visuals\n    shouldRender && this.requestRenderAll();\n  }\n\n  /**\n   * reset cache form common information needed during event processing\n   * @private\n   */\n  _resetTransformEventData() {\n    this._target = this._pointer = this._absolutePointer = undefined;\n  }\n\n  /**\n   * Cache common information needed during event processing\n   * @private\n   * @param {Event} e Event object fired on event\n   */\n  _cacheTransformEventData(e: TPointerEvent) {\n    // reset in order to avoid stale caching\n    this._resetTransformEventData();\n    this._pointer = this.getViewportPoint(e);\n    this._absolutePointer = sendPointToPlane(\n      this._pointer,\n      undefined,\n      this.viewportTransform,\n    );\n    this._target = this._currentTransform\n      ? this._currentTransform.target\n      : this.findTarget(e);\n  }\n\n  /**\n   * Method that defines the actions when mouse is hovering the canvas.\n   * The currentTransform parameter will define whether the user is rotating/scaling/translating\n   * an image or neither of them (only hovering). A group selection is also possible and would cancel\n   * all any other type of action.\n   * In case of an image transformation only the top canvas will be rendered.\n   * @private\n   * @param {Event} e Event object fired on mousemove\n   */\n  __onMouseMove(e: TPointerEvent) {\n    this._isClick = false;\n    this._cacheTransformEventData(e);\n    this._handleEvent(e, 'move:before');\n\n    if (this.isDrawingMode) {\n      this._onMouseMoveInDrawingMode(e);\n      return;\n    }\n\n    if (!this._isMainEvent(e)) {\n      return;\n    }\n\n    const groupSelector = this._groupSelector;\n\n    // We initially clicked in an empty area, so we draw a box for multiple selection\n    if (groupSelector) {\n      const pointer = this.getScenePoint(e);\n\n      groupSelector.deltaX = pointer.x - groupSelector.x;\n      groupSelector.deltaY = pointer.y - groupSelector.y;\n\n      this.renderTop();\n    } else if (!this._currentTransform) {\n      const target = this.findTarget(e);\n      this._setCursorFromEvent(e, target);\n      this._fireOverOutEvents(e, target);\n    } else {\n      this._transformObject(e);\n    }\n    this.textEditingManager.onMouseMove(e);\n    this._handleEvent(e, 'move');\n    this._resetTransformEventData();\n  }\n\n  /**\n   * Manage the mouseout, mouseover events for the fabric object on the canvas\n   * @param {Fabric.Object} target the target where the target from the mousemove event\n   * @param {Event} e Event object fired on mousemove\n   * @private\n   */\n  _fireOverOutEvents(e: TPointerEvent, target?: FabricObject) {\n    const _hoveredTarget = this._hoveredTarget,\n      _hoveredTargets = this._hoveredTargets,\n      targets = this.targets,\n      length = Math.max(_hoveredTargets.length, targets.length);\n\n    this.fireSyntheticInOutEvents('mouse', {\n      e,\n      target,\n      oldTarget: _hoveredTarget,\n      fireCanvas: true,\n    });\n    for (let i = 0; i < length; i++) {\n      this.fireSyntheticInOutEvents('mouse', {\n        e,\n        target: targets[i],\n        oldTarget: _hoveredTargets[i],\n      });\n    }\n    this._hoveredTarget = target;\n    this._hoveredTargets = this.targets.concat();\n  }\n\n  /**\n   * Manage the dragEnter, dragLeave events for the fabric objects on the canvas\n   * @param {Fabric.Object} target the target where the target from the onDrag event\n   * @param {Object} data Event object fired on dragover\n   * @private\n   */\n  _fireEnterLeaveEvents(target: FabricObject | undefined, data: DragEventData) {\n    const draggedoverTarget = this._draggedoverTarget,\n      _hoveredTargets = this._hoveredTargets,\n      targets = this.targets,\n      length = Math.max(_hoveredTargets.length, targets.length);\n\n    this.fireSyntheticInOutEvents('drag', {\n      ...data,\n      target,\n      oldTarget: draggedoverTarget,\n      fireCanvas: true,\n    });\n    for (let i = 0; i < length; i++) {\n      this.fireSyntheticInOutEvents('drag', {\n        ...data,\n        target: targets[i],\n        oldTarget: _hoveredTargets[i],\n      });\n    }\n    this._draggedoverTarget = target;\n  }\n\n  /**\n   * Manage the synthetic in/out events for the fabric objects on the canvas\n   * @param {Fabric.Object} target the target where the target from the supported events\n   * @param {Object} data Event object fired\n   * @param {Object} config configuration for the function to work\n   * @param {String} config.targetName property on the canvas where the old target is stored\n   * @param {String} [config.canvasEvtOut] name of the event to fire at canvas level for out\n   * @param {String} config.evtOut name of the event to fire for out\n   * @param {String} [config.canvasEvtIn] name of the event to fire at canvas level for in\n   * @param {String} config.evtIn name of the event to fire for in\n   * @private\n   */\n  fireSyntheticInOutEvents<T extends keyof TSyntheticEventContext>(\n    type: T,\n    {\n      target,\n      oldTarget,\n      fireCanvas,\n      e,\n      ...data\n    }: TSyntheticEventContext[T] & {\n      target?: FabricObject;\n      oldTarget?: FabricObject;\n      fireCanvas?: boolean;\n    },\n  ) {\n    const { targetIn, targetOut, canvasIn, canvasOut } =\n      syntheticEventConfig[type];\n    const targetChanged = oldTarget !== target;\n\n    if (oldTarget && targetChanged) {\n      const outOpt: CanvasEvents[typeof canvasOut] = {\n        ...data,\n        e,\n        target: oldTarget,\n        nextTarget: target,\n        ...getEventPoints(this, e),\n      };\n      fireCanvas && this.fire(canvasOut, outOpt);\n      oldTarget.fire(targetOut, outOpt);\n    }\n    if (target && targetChanged) {\n      const inOpt: CanvasEvents[typeof canvasIn] = {\n        ...data,\n        e,\n        target,\n        previousTarget: oldTarget,\n        ...getEventPoints(this, e),\n      };\n      fireCanvas && this.fire(canvasIn, inOpt);\n      target.fire(targetIn, inOpt);\n    }\n  }\n\n  /**\n   * Method that defines actions when an Event Mouse Wheel\n   * @param {Event} e Event object fired on mouseup\n   */\n  __onMouseWheel(e: TPointerEvent) {\n    this._cacheTransformEventData(e);\n    this._handleEvent(e, 'wheel');\n    this._resetTransformEventData();\n  }\n\n  /**\n   * @private\n   * @param {Event} e Event fired on mousemove\n   */\n  _transformObject(e: TPointerEvent) {\n    const scenePoint = this.getScenePoint(e),\n      transform = this._currentTransform!,\n      target = transform.target,\n      //  transform pointer to target's containing coordinate plane\n      //  both pointer and object should agree on every point\n      localPointer = target.group\n        ? sendPointToPlane(\n            scenePoint,\n            undefined,\n            target.group.calcTransformMatrix(),\n          )\n        : scenePoint;\n    transform.shiftKey = e.shiftKey;\n    transform.altKey = !!this.centeredKey && e[this.centeredKey];\n\n    this._performTransformAction(e, transform, localPointer);\n    transform.actionPerformed && this.requestRenderAll();\n  }\n\n  /**\n   * @private\n   */\n  _performTransformAction(\n    e: TPointerEvent,\n    transform: Transform,\n    pointer: Point,\n  ) {\n    const { action, actionHandler, target } = transform;\n\n    const actionPerformed =\n      !!actionHandler && actionHandler(e, transform, pointer.x, pointer.y);\n    actionPerformed && target.setCoords();\n\n    // this object could be created from the function in the control handlers\n    if (action === 'drag' && actionPerformed) {\n      transform.target.isMoving = true;\n      this.setCursor(transform.target.moveCursor || this.moveCursor);\n    }\n    transform.actionPerformed = transform.actionPerformed || actionPerformed;\n  }\n\n  /**\n   * Sets the cursor depending on where the canvas is being hovered.\n   * Note: very buggy in Opera\n   * @param {Event} e Event object\n   * @param {Object} target Object that the mouse is hovering, if so.\n   */\n  _setCursorFromEvent(e: TPointerEvent, target?: FabricObject) {\n    if (!target) {\n      this.setCursor(this.defaultCursor);\n      return;\n    }\n    let hoverCursor = target.hoverCursor || this.hoverCursor;\n    const activeSelection = isActiveSelection(this._activeObject)\n        ? this._activeObject\n        : null,\n      // only show proper corner when group selection is not active\n      corner =\n        (!activeSelection || target.group !== activeSelection) &&\n        // here we call findTargetCorner always with undefined for the touch parameter.\n        // we assume that if you are using a cursor you do not need to interact with\n        // the bigger touch area.\n        target.findControl(this.getViewportPoint(e));\n\n    if (!corner) {\n      if ((target as Group).subTargetCheck) {\n        // hoverCursor should come from top-most subTarget,\n        // so we walk the array backwards\n        this.targets\n          .concat()\n          .reverse()\n          .map((_target) => {\n            hoverCursor = _target.hoverCursor || hoverCursor;\n          });\n      }\n      this.setCursor(hoverCursor);\n    } else {\n      const control = corner.control;\n      this.setCursor(control.cursorStyleHandler(e, control, target));\n    }\n  }\n\n  /**\n   * ## Handles multiple selection\n   * - toggles `target` selection (selects/deselects `target` if it isn't/is selected respectively)\n   * - sets the active object in case it is not set or in case there is a single active object left under active selection.\n   * ---\n   * - If the active object is the active selection we add/remove `target` from it\n   * - If not, add the active object and `target` to the active selection and make it the active object.\n   * @private\n   * @param {TPointerEvent} e Event object\n   * @param {FabricObject} target target of event to select/deselect\n   * @returns true if grouping occurred\n   */\n  protected handleMultiSelection(e: TPointerEvent, target?: FabricObject) {\n    const activeObject = this._activeObject;\n    const isAS = isActiveSelection(activeObject);\n    if (\n      // check if an active object exists on canvas and if the user is pressing the `selectionKey` while canvas supports multi selection.\n      !!activeObject &&\n      this._isSelectionKeyPressed(e) &&\n      this.selection &&\n      // on top of that the user also has to hit a target that is selectable.\n      !!target &&\n      target.selectable &&\n      // group target and active object only if they are different objects\n      // else we try to find a subtarget of `ActiveSelection`\n      (activeObject !== target || isAS) &&\n      //  make sure `activeObject` and `target` aren't ancestors of each other in case `activeObject` is not `ActiveSelection`\n      // if it is then we want to remove `target` from it\n      (isAS ||\n        (!target.isDescendantOf(activeObject) &&\n          !activeObject.isDescendantOf(target))) &&\n      //  target accepts selection\n      !target.onSelect({ e }) &&\n      // make sure we are not on top of a control\n      !activeObject.getActiveControl()\n    ) {\n      if (isAS) {\n        const prevActiveObjects = activeObject.getObjects();\n        if (target === activeObject) {\n          const pointer = this.getViewportPoint(e);\n          target =\n            // first search active objects for a target to remove\n            this.searchPossibleTargets(prevActiveObjects, pointer) ||\n            //  if not found, search under active selection for a target to add\n            // `prevActiveObjects` will be searched but we already know they will not be found\n            this.searchPossibleTargets(this._objects, pointer);\n          // if nothing is found bail out\n          if (!target || !target.selectable) {\n            return false;\n          }\n        }\n        if (target.group === activeObject) {\n          // `target` is part of active selection => remove it\n          activeObject.remove(target);\n          this._hoveredTarget = target;\n          this._hoveredTargets = [...this.targets];\n          // if after removing an object we are left with one only...\n          if (activeObject.size() === 1) {\n            // activate last remaining object\n            // deselecting the active selection will remove the remaining object from it\n            this._setActiveObject(activeObject.item(0), e);\n          }\n        } else {\n          // `target` isn't part of active selection => add it\n          activeObject.multiSelectAdd(target);\n          this._hoveredTarget = activeObject;\n          this._hoveredTargets = [...this.targets];\n        }\n        this._fireSelectionEvents(prevActiveObjects, e);\n      } else {\n        (activeObject as IText).isEditing &&\n          (activeObject as IText).exitEditing();\n        // add the active object and the target to the active selection and set it as the active object\n        const klass =\n          classRegistry.getClass<typeof ActiveSelection>('ActiveSelection');\n        const newActiveSelection = new klass([], {\n          /**\n           * it is crucial to pass the canvas ref before calling {@link ActiveSelection#multiSelectAdd}\n           * since it uses {@link FabricObject#isInFrontOf} which relies on the canvas ref\n           */\n          canvas: this,\n        });\n        newActiveSelection.multiSelectAdd(activeObject, target);\n        this._hoveredTarget = newActiveSelection;\n        // ISSUE 4115: should we consider subTargets here?\n        // this._hoveredTargets = [];\n        // this._hoveredTargets = this.targets.concat();\n        this._setActiveObject(newActiveSelection, e);\n        this._fireSelectionEvents([activeObject], e);\n      }\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * ## Handles selection\n   * - selects objects that are contained in (and possibly intersecting) the selection bounding box\n   * - sets the active object\n   * ---\n   * runs on mouse up after a mouse move\n   */\n  protected handleSelection(e: TPointerEvent) {\n    if (!this.selection || !this._groupSelector) {\n      return false;\n    }\n    const { x, y, deltaX, deltaY } = this._groupSelector,\n      point1 = new Point(x, y),\n      point2 = point1.add(new Point(deltaX, deltaY)),\n      tl = point1.min(point2),\n      br = point1.max(point2),\n      size = br.subtract(tl);\n\n    const collectedObjects = this.collectObjects(\n      {\n        left: tl.x,\n        top: tl.y,\n        width: size.x,\n        height: size.y,\n      },\n      { includeIntersecting: !this.selectionFullyContained },\n    ) as FabricObject[];\n\n    const objects =\n      // though this method runs only after mouse move the pointer could do a mouse up on the same position as mouse down\n      // should it be handled as is?\n      point1.eq(point2)\n        ? collectedObjects[0]\n          ? [collectedObjects[0]]\n          : []\n        : collectedObjects.length > 1\n          ? collectedObjects\n              .filter((object) => !object.onSelect({ e }))\n              .reverse()\n          : // `setActiveObject` will call `onSelect(collectedObjects[0])` in this case\n            collectedObjects;\n\n    // set active object\n    if (objects.length === 1) {\n      // set as active object\n      this.setActiveObject(objects[0], e);\n    } else if (objects.length > 1) {\n      // add to active selection and make it the active object\n      const klass =\n        classRegistry.getClass<typeof ActiveSelection>('ActiveSelection');\n      this.setActiveObject(new klass(objects, { canvas: this }), e);\n    }\n\n    // cleanup\n    this._groupSelector = null;\n    return true;\n  }\n\n  /**\n   * @override clear {@link textEditingManager}\n   */\n  clear() {\n    this.textEditingManager.clear();\n    super.clear();\n  }\n\n  /**\n   * @override clear {@link textEditingManager}\n   */\n  destroy() {\n    this.removeListeners();\n    this.textEditingManager.dispose();\n    super.destroy();\n  }\n}\n"],"names":["addEventOptions","passive","getEventPoints","canvas","e","viewportPoint","getViewportPoint","scenePoint","getScenePoint","pointer","absolutePointer","addListener","el","_len","arguments","length","args","Array","_key","addEventListener","removeListener","_len2","_key2","removeEventListener","syntheticEventConfig","mouse","in","out","targetIn","targetOut","canvasIn","canvasOut","drag","Canvas","SelectableCanvas","constructor","options","undefined","_defineProperty","TextEditingManager","forEach","eventHandler","bind","addOrRemove","_getEventPrefix","enablePointerEvents","functor","_eventjsFunctor","canvasElement","upperCanvasEl","eventTypePrefix","getWindowFromElement","_onResize","_onMouseDown","concat","_onMouseMove","_onMouseOut","_onMouseEnter","_onMouseWheel","_onContextMenu","_onClick","_onDragStart","_onDragEnd","_onDragOver","_onDragEnter","_onDragLeave","_onDrop","_onTouchStart","removeListeners","doc","getDocumentFromElement","_onMouseUp","_onTouchEnd","clearTimeout","_willAddMouseDown","__onMouseWheel","target","_hoveredTarget","shared","_objectSpread","fire","_hoveredTargets","nestedTarget","_currentTransform","findTarget","_isClick","activeObject","getActiveObject","onDragStart","_dragSource","_onDragProgress","stopEvent","_renderDragEffects","source","dirty","dropTarget","_dropTarget","clearContextTop","ctx","contextTop","save","transform","viewportTransform","renderDragSourceEffect","restore","renderDropTargetEffect","contextTopDirty","didDrop","dataTransfer","dropEffect","NONE","_activeObject","subTargets","targets","dragSource","_draggedoverTarget","findDragTargets","_searchPossibleTargets","_objects","eventType","canDrop","_fireEnterLeaveEvents","i","subTarget","_basicEventHandler","stopContextMenu","clicks","detail","_cacheTransformEventData","type","_handleEvent","_resetTransformEventData","getPointerId","evt","changedTouches","identifier","pointerId","_isMainEvent","isPrimary","touches","mainTouchId","shouldPreventScrolling","allowTouchScrolling","currentActiveObject","__onMouseDown","isDrawingMode","_target","preventDefault","__onMouseUp","setTimeout","shouldStartDragging","__onMouseMove","calcOffset","_shouldRender","_this$_activeObject","isClick","button","fireMiddleClick","fireRightClick","_isCurrentlyDrawing","_onMouseUpInDrawingMode","shouldRender","_finalizeCurrentTransform","actionPerformed","targetWasActive","handleSelection","corner","found","findControl","isTouchEvent","key","control","selectable","activeOn","setActiveObject","mouseUpHandler","getMouseUpHandler","call","x","y","isMoving","originalControl","controls","originalMouseUpHandler","_setCursorFromEvent","_groupSelector","__corner","requestRenderAll","isEditing","renderTop","extraData","currentTarget","currentSubTargets","_onMouseDownInDrawingMode","discardActiveObject","freeDrawingBrush","onMouseDown","alreadySelected","_onMouseMoveInDrawingMode","onMouseMove","setCursor","freeDrawingCursor","onMouseUp","grouped","handleMultiSelection","_shouldClearSelection","selection","p","deltaY","deltaX","handle","_setupCurrentTransform","mouseDownHandler","getMouseDownHandler","_objectsToRender","_pointer","_absolutePointer","sendPointToPlane","groupSelector","_fireOverOutEvents","_transformObject","textEditingManager","Math","max","fireSyntheticInOutEvents","oldTarget","fireCanvas","data","draggedoverTarget","_ref","_objectWithoutProperties","_excluded","targetChanged","outOpt","nextTarget","inOpt","previousTarget","localPointer","group","calcTransformMatrix","shiftKey","altKey","centeredKey","_performTransformAction","action","actionHandler","setCoords","moveCursor","defaultCursor","hoverCursor","activeSelection","isActiveSelection","subTargetCheck","reverse","map","cursorStyleHandler","isAS","_isSelectionKeyPressed","isDescendantOf","onSelect","getActiveControl","prevActiveObjects","getObjects","searchPossibleTargets","remove","size","_setActiveObject","item","multiSelectAdd","_fireSelectionEvents","exitEditing","klass","classRegistry","getClass","newActiveSelection","point1","Point","point2","add","tl","min","br","subtract","collectedObjects","collectObjects","left","top","width","height","includeIntersecting","selectionFullyContained","objects","eq","filter","object","clear","destroy","dispose"],"mappings":"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"}