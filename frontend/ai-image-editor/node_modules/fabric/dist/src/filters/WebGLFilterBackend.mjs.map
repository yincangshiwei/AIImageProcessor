{"version":3,"file":"WebGLFilterBackend.mjs","sources":["../../../src/filters/WebGLFilterBackend.ts"],"sourcesContent":["import { config } from '../config';\nimport { createCanvasElementFor } from '../util/misc/dom';\nimport type {\n  TWebGLPipelineState,\n  TProgramCache,\n  TTextureCache,\n  TPipelineResources,\n} from './typedefs';\nimport type { BaseFilter } from './BaseFilter';\n\nexport class WebGLFilterBackend {\n  declare tileSize: number;\n\n  /**\n   * Define ...\n   **/\n  aPosition: Float32Array = new Float32Array([0, 0, 0, 1, 1, 0, 1, 1]);\n\n  /**\n   * If GLPut data is the fastest operation, or if forced, this buffer will be used\n   * to transfer the data back in the 2d logic\n   **/\n  declare imageBuffer?: ArrayBuffer;\n\n  declare canvas: HTMLCanvasElement;\n\n  /**\n   * The Webgl context that will execute the operations for filtering\n   **/\n  declare gl: WebGLRenderingContext;\n\n  /**\n   * Keyed map for shader cache\n   **/\n  declare programCache: TProgramCache;\n\n  /**\n   * Keyed map for texture cache\n   **/\n  declare textureCache: TTextureCache;\n\n  /**\n   * Contains GPU info for debug\n   **/\n  declare gpuInfo: any;\n\n  /**\n   * Experimental. This object is a sort of repository of help layers used to avoid\n   * of recreating them during frequent filtering. If you are previewing a filter with\n   * a slider you probably do not want to create help layers every filter step.\n   * in this object there will be appended some canvases, created once, resized sometimes\n   * cleared never. Clearing is left to the developer.\n   **/\n  resources: TPipelineResources = {};\n\n  constructor({ tileSize = config.textureSize } = {}) {\n    this.tileSize = tileSize;\n    this.setupGLContext(tileSize, tileSize);\n    this.captureGPUInfo();\n  }\n\n  /**\n   * Setup a WebGL context suitable for filtering, and bind any needed event handlers.\n   */\n  setupGLContext(width: number, height: number): void {\n    this.dispose();\n    this.createWebGLCanvas(width, height);\n  }\n\n  /**\n   * Create a canvas element and associated WebGL context and attaches them as\n   * class properties to the GLFilterBackend class.\n   */\n  createWebGLCanvas(width: number, height: number): void {\n    const canvas = createCanvasElementFor({ width, height });\n    const glOptions = {\n        alpha: true,\n        premultipliedAlpha: false,\n        depth: false,\n        stencil: false,\n        antialias: false,\n      },\n      gl = canvas.getContext('webgl', glOptions) as WebGLRenderingContext;\n\n    if (!gl) {\n      return;\n    }\n    gl.clearColor(0, 0, 0, 0);\n    // this canvas can fire webglcontextlost and webglcontextrestored\n    this.canvas = canvas;\n    this.gl = gl;\n  }\n\n  /**\n   * Attempts to apply the requested filters to the source provided, drawing the filtered output\n   * to the provided target canvas.\n   *\n   * @param {Array} filters The filters to apply.\n   * @param {TexImageSource} source The source to be filtered.\n   * @param {Number} width The width of the source input.\n   * @param {Number} height The height of the source input.\n   * @param {HTMLCanvasElement} targetCanvas The destination for filtered output to be drawn.\n   * @param {String|undefined} cacheKey A key used to cache resources related to the source. If\n   * omitted, caching will be skipped.\n   */\n  applyFilters(\n    filters: BaseFilter<string, Record<string, any>>[],\n    source: TexImageSource,\n    width: number,\n    height: number,\n    targetCanvas: HTMLCanvasElement,\n    cacheKey?: string,\n  ): TWebGLPipelineState | undefined {\n    const gl = this.gl;\n    const ctx = targetCanvas.getContext('2d');\n    if (!gl || !ctx) {\n      return;\n    }\n    let cachedTexture;\n    if (cacheKey) {\n      cachedTexture = this.getCachedTexture(cacheKey, source);\n    }\n    const pipelineState: TWebGLPipelineState = {\n      originalWidth:\n        (source as HTMLImageElement).width ||\n        (source as HTMLImageElement).naturalWidth ||\n        0,\n      originalHeight:\n        (source as HTMLImageElement).height ||\n        (source as HTMLImageElement).naturalHeight ||\n        0,\n      sourceWidth: width,\n      sourceHeight: height,\n      destinationWidth: width,\n      destinationHeight: height,\n      context: gl,\n      sourceTexture: this.createTexture(\n        gl,\n        width,\n        height,\n        !cachedTexture ? source : undefined,\n      ),\n      targetTexture: this.createTexture(gl, width, height),\n      originalTexture:\n        cachedTexture ||\n        this.createTexture(\n          gl,\n          width,\n          height,\n          !cachedTexture ? source : undefined,\n        )!,\n      passes: filters.length,\n      webgl: true,\n      aPosition: this.aPosition,\n      programCache: this.programCache,\n      pass: 0,\n      filterBackend: this,\n      targetCanvas: targetCanvas,\n    };\n    const tempFbo = gl.createFramebuffer();\n    gl.bindFramebuffer(gl.FRAMEBUFFER, tempFbo);\n    filters.forEach((filter: any) => {\n      filter && filter.applyTo(pipelineState);\n    });\n    resizeCanvasIfNeeded(pipelineState);\n    this.copyGLTo2D(gl, pipelineState);\n    gl.bindTexture(gl.TEXTURE_2D, null);\n    gl.deleteTexture(pipelineState.sourceTexture);\n    gl.deleteTexture(pipelineState.targetTexture);\n    gl.deleteFramebuffer(tempFbo);\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\n    return pipelineState;\n  }\n\n  /**\n   * Detach event listeners, remove references, and clean up caches.\n   */\n  dispose() {\n    if (this.canvas) {\n      // we are disposing, we don't care about the fact\n      // that the canvas shouldn't be null.\n      // @ts-expect-error disposing\n      this.canvas = null;\n      // @ts-expect-error disposing\n      this.gl = null;\n    }\n    this.clearWebGLCaches();\n  }\n\n  /**\n   * Wipe out WebGL-related caches.\n   */\n  clearWebGLCaches() {\n    this.programCache = {};\n    this.textureCache = {};\n  }\n\n  /**\n   * Create a WebGL texture object.\n   *\n   * Accepts specific dimensions to initialize the texture to or a source image.\n   *\n   * @param {WebGLRenderingContext} gl The GL context to use for creating the texture.\n   * @param {number} width The width to initialize the texture at.\n   * @param {number} height The height to initialize the texture.\n   * @param {TexImageSource} textureImageSource A source for the texture data.\n   * @param {number} filter gl.NEAREST default or gl.LINEAR filters for the texture.\n   * This filter is very useful for LUTs filters. If you need interpolation use gl.LINEAR\n   * @returns {WebGLTexture}\n   */\n  createTexture(\n    gl: WebGLRenderingContext,\n    width: number,\n    height: number,\n    textureImageSource?: TexImageSource,\n    filter?:\n      | WebGLRenderingContextBase['NEAREST']\n      | WebGLRenderingContextBase['LINEAR'],\n  ) {\n    const {\n      NEAREST,\n      TEXTURE_2D,\n      RGBA,\n      UNSIGNED_BYTE,\n      CLAMP_TO_EDGE,\n      TEXTURE_MAG_FILTER,\n      TEXTURE_MIN_FILTER,\n      TEXTURE_WRAP_S,\n      TEXTURE_WRAP_T,\n    } = gl;\n    const texture = gl.createTexture();\n    gl.bindTexture(TEXTURE_2D, texture);\n    gl.texParameteri(TEXTURE_2D, TEXTURE_MAG_FILTER, filter || NEAREST);\n    gl.texParameteri(TEXTURE_2D, TEXTURE_MIN_FILTER, filter || NEAREST);\n    gl.texParameteri(TEXTURE_2D, TEXTURE_WRAP_S, CLAMP_TO_EDGE);\n    gl.texParameteri(TEXTURE_2D, TEXTURE_WRAP_T, CLAMP_TO_EDGE);\n    if (textureImageSource) {\n      gl.texImage2D(\n        TEXTURE_2D,\n        0,\n        RGBA,\n        RGBA,\n        UNSIGNED_BYTE,\n        textureImageSource,\n      );\n    } else {\n      gl.texImage2D(\n        TEXTURE_2D,\n        0,\n        RGBA,\n        width,\n        height,\n        0,\n        RGBA,\n        UNSIGNED_BYTE,\n        null,\n      );\n    }\n    return texture;\n  }\n\n  /**\n   * Can be optionally used to get a texture from the cache array\n   *\n   * If an existing texture is not found, a new texture is created and cached.\n   *\n   * @param {String} uniqueId A cache key to use to find an existing texture.\n   * @param {HTMLImageElement|HTMLCanvasElement} textureImageSource A source to use to create the\n   * texture cache entry if one does not already exist.\n   */\n  getCachedTexture(\n    uniqueId: string,\n    textureImageSource: TexImageSource,\n    filter?:\n      | WebGLRenderingContextBase['NEAREST']\n      | WebGLRenderingContextBase['LINEAR'],\n  ): WebGLTexture | null {\n    const { textureCache } = this;\n    if (textureCache[uniqueId]) {\n      return textureCache[uniqueId];\n    } else {\n      const texture = this.createTexture(\n        this.gl,\n        (textureImageSource as HTMLImageElement).width,\n        (textureImageSource as HTMLImageElement).height,\n        textureImageSource,\n        filter,\n      );\n      if (texture) {\n        textureCache[uniqueId] = texture;\n      }\n      return texture;\n    }\n  }\n\n  /**\n   * Clear out cached resources related to a source image that has been\n   * filtered previously.\n   *\n   * @param {String} cacheKey The cache key provided when the source image was filtered.\n   */\n  evictCachesForKey(cacheKey: string) {\n    if (this.textureCache[cacheKey]) {\n      this.gl.deleteTexture(this.textureCache[cacheKey]);\n      delete this.textureCache[cacheKey];\n    }\n  }\n\n  /**\n   * Copy an input WebGL canvas on to an output 2D canvas.\n   *\n   * The WebGL canvas is assumed to be upside down, with the top-left pixel of the\n   * desired output image appearing in the bottom-left corner of the WebGL canvas.\n   *\n   * @param {WebGLRenderingContext} sourceContext The WebGL context to copy from.\n   * @param {Object} pipelineState The 2D target canvas to copy on to.\n   */\n  copyGLTo2D(gl: WebGLRenderingContext, pipelineState: TWebGLPipelineState) {\n    const glCanvas = gl.canvas,\n      targetCanvas = pipelineState.targetCanvas,\n      ctx = targetCanvas.getContext('2d');\n    if (!ctx) {\n      return;\n    }\n    ctx.translate(0, targetCanvas.height); // move it down again\n    ctx.scale(1, -1); // vertical flip\n    // where is my image on the big glcanvas?\n    const sourceY = glCanvas.height - targetCanvas.height;\n    ctx.drawImage(\n      glCanvas,\n      0,\n      sourceY,\n      targetCanvas.width,\n      targetCanvas.height,\n      0,\n      0,\n      targetCanvas.width,\n      targetCanvas.height,\n    );\n  }\n\n  /**\n   * Copy an input WebGL canvas on to an output 2D canvas using 2d canvas' putImageData\n   * API. Measurably faster than using ctx.drawImage in Firefox (version 54 on OSX Sierra).\n   *\n   * @param {WebGLRenderingContext} sourceContext The WebGL context to copy from.\n   * @param {HTMLCanvasElement} targetCanvas The 2D target canvas to copy on to.\n   * @param {Object} pipelineState The 2D target canvas to copy on to.\n   */\n  copyGLTo2DPutImageData(\n    this: Required<WebGLFilterBackend>,\n    gl: WebGLRenderingContext,\n    pipelineState: TWebGLPipelineState,\n  ) {\n    const targetCanvas = pipelineState.targetCanvas,\n      ctx = targetCanvas.getContext('2d'),\n      dWidth = pipelineState.destinationWidth,\n      dHeight = pipelineState.destinationHeight,\n      numBytes = dWidth * dHeight * 4;\n    if (!ctx) {\n      return;\n    }\n    const u8 = new Uint8Array(this.imageBuffer, 0, numBytes);\n    const u8Clamped = new Uint8ClampedArray(this.imageBuffer, 0, numBytes);\n\n    gl.readPixels(0, 0, dWidth, dHeight, gl.RGBA, gl.UNSIGNED_BYTE, u8);\n    const imgData = new ImageData(u8Clamped, dWidth, dHeight);\n    ctx.putImageData(imgData, 0, 0);\n  }\n\n  /**\n   * Attempt to extract GPU information strings from a WebGL context.\n   *\n   * Useful information when debugging or blacklisting specific GPUs.\n   *\n   * @returns {Object} A GPU info object with renderer and vendor strings.\n   */\n  captureGPUInfo() {\n    if (this.gpuInfo) {\n      return this.gpuInfo;\n    }\n    const gl = this.gl,\n      gpuInfo = { renderer: '', vendor: '' };\n    if (!gl) {\n      return gpuInfo;\n    }\n    const ext = gl.getExtension('WEBGL_debug_renderer_info');\n    if (ext) {\n      const renderer = gl.getParameter(ext.UNMASKED_RENDERER_WEBGL);\n      const vendor = gl.getParameter(ext.UNMASKED_VENDOR_WEBGL);\n      if (renderer) {\n        gpuInfo.renderer = renderer.toLowerCase();\n      }\n      if (vendor) {\n        gpuInfo.vendor = vendor.toLowerCase();\n      }\n    }\n    this.gpuInfo = gpuInfo;\n    return gpuInfo;\n  }\n}\n\nfunction resizeCanvasIfNeeded(pipelineState: TWebGLPipelineState): void {\n  const targetCanvas = pipelineState.targetCanvas,\n    width = targetCanvas.width,\n    height = targetCanvas.height,\n    dWidth = pipelineState.destinationWidth,\n    dHeight = pipelineState.destinationHeight;\n\n  if (width !== dWidth || height !== dHeight) {\n    targetCanvas.width = dWidth;\n    targetCanvas.height = dHeight;\n  }\n}\n"],"names":["WebGLFilterBackend","constructor","tileSize","config","textureSize","arguments","length","undefined","_defineProperty","Float32Array","setupGLContext","captureGPUInfo","width","height","dispose","createWebGLCanvas","canvas","createCanvasElementFor","glOptions","alpha","premultipliedAlpha","depth","stencil","antialias","gl","getContext","clearColor","applyFilters","filters","source","targetCanvas","cacheKey","ctx","cachedTexture","getCachedTexture","pipelineState","originalWidth","naturalWidth","originalHeight","naturalHeight","sourceWidth","sourceHeight","destinationWidth","destinationHeight","context","sourceTexture","createTexture","targetTexture","originalTexture","passes","webgl","aPosition","programCache","pass","filterBackend","tempFbo","createFramebuffer","bindFramebuffer","FRAMEBUFFER","forEach","filter","applyTo","resizeCanvasIfNeeded","copyGLTo2D","bindTexture","TEXTURE_2D","deleteTexture","deleteFramebuffer","setTransform","clearWebGLCaches","textureCache","textureImageSource","NEAREST","RGBA","UNSIGNED_BYTE","CLAMP_TO_EDGE","TEXTURE_MAG_FILTER","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","TEXTURE_WRAP_T","texture","texParameteri","texImage2D","uniqueId","evictCachesForKey","glCanvas","translate","scale","sourceY","drawImage","copyGLTo2DPutImageData","dWidth","dHeight","numBytes","u8","Uint8Array","imageBuffer","u8Clamped","Uint8ClampedArray","readPixels","imgData","ImageData","putImageData","gpuInfo","renderer","vendor","ext","getExtension","getParameter","UNMASKED_RENDERER_WEBGL","UNMASKED_VENDOR_WEBGL","toLowerCase"],"mappings":"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"}